{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        
        <!-- VISTA DE LOGIN -->
        <div id="loginSection" class="search-box text-center">
            <h2 class="mb-4">üîê Identificaci√≥n</h2>
            <p class="text-muted">Ingrese su <strong>Nombre</strong> para continuar</p>
            
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" id="userInput" class="form-control" placeholder="Escriba su nombre">
                    </div>
                    <button onclick="loginUser()" class="btn btn-brown w-100">
                        <i class="fas fa-sign-in-alt me-2"></i>Ingresar
                    </button>
                    <div id="loginError" class="text-danger mt-2 small"></div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-brown-outline btn-sm">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Men√∫
                </a>
            </div>
        </div>

        <!-- VISTA DE APLICACI√ìN -->
        <div id="appSection" style="display:none;">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>üìã Solicitudes</h4>
                <button onclick="logout()" class="btn btn-brown-outline btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i> Salir
                </button>
            </div>

            <!-- Info Usuario -->
            <div class="search-box p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Bienvenido: <strong id="userNameDisplay"></strong></span>
                    <span id="roleDisplay" class="badge bg-secondary"></span>
                </div>
            </div>

            <!-- FORMULARIO (Solo para Solicitantes) -->
            <div id="formContainer" class="search-box">
                <h5 class="mb-3"><i class="fas fa-plus-circle me-2"></i>Nueva Solicitud</h5>
                
                <!-- CAMPO NUEVO: TIPO DE SOLICITUD -->
                <div class="mb-3">
                    <label class="form-label small fw-bold">Tipo de Solicitud</label>
                    <select id="inputTipo" class="form-select" onchange="cambiarTipoFormulario()">
                        <option value="Devoluci√≥n">Devoluci√≥n de Dinero</option>
                        <option value="Otro">Otros</option>
                    </select>
                </div>

                <!-- CAMPOS ESPECIFICOS PARA DEVOLUCI√ìN (Se ocultan si es "Otro") -->
                <div id="devolucionFields">
                    <div class="row mb-3">
                        <div class="col-md-7">
                            <label class="form-label small fw-bold">Nombre de la Clienta</label>
                            <input type="text" id="inputCliente" class="form-control" placeholder="Nombre de quien devuelve">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small fw-bold">Monto ($)</label>
                            <input type="number" id="inputMonto" class="form-control" placeholder="0.00">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Banco</label>
                            <input type="text" id="inputBanco" class="form-control" placeholder="Ej: BancoEstado">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">RUT</label>
                            <input type="text" id="inputRut" class="form-control" placeholder="Ej: 12.345.678-9">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Email</label>
                            <input type="email" id="inputEmail" class="form-control" placeholder="correo@ejemplo.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Fecha</label>
                            <input type="text" id="inputFecha" class="form-control" disabled style="background-color: #e9ecef;">
                        </div>
                    </div>
                </div>

                <!-- MOTIVO / DETALLE (Com√∫n para ambos, cambia etiqueta) -->
                <div class="mb-3">
                    <label class="form-label small fw-bold" id="labelMotivo">Motivo / Observaci√≥n</label>
                    <textarea id="inputMotivo" class="form-control" rows="3" placeholder="Detalle aqu√≠..."></textarea>
                </div>

                <button onclick="crearSolicitud()" class="btn btn-brown w-100">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud
                </button>
            </div>
            <!-- FIN FORMULARIO -->

            <!-- Listado -->
            <div class="search-box mt-4">
                <h5 class="mb-3"><i class="fas fa-list me-2"></i>Listado</h5>
                <div id="listaSolicitudes">
                    <p class="text-center text-muted">Cargando...</p>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
    let isAdmin = false;

    function getTodayDate() {
        const today = new Date();
        return today.toLocaleDateString('es-CL');
    }

    // Funci√≥n para mostrar/ocultar campos seg√∫n el tipo
    function cambiarTipoFormulario() {
        const tipo = document.getElementById('inputTipo').value;
        const devolucionDiv = document.getElementById('devolucionFields');
        const labelMotivo = document.getElementById('labelMotivo');
        
        if(tipo === 'Devoluci√≥n') {
            devolucionDiv.style.display = 'block';
            labelMotivo.innerText = "Motivo / Observaci√≥n";
        } else {
            devolucionDiv.style.display = 'none';
            labelMotivo.innerText = "Detalle de la Solicitud";
        }
    }

    async function loginUser() {
        const inputVal = document.getElementById('userInput').value.trim();
        const errorDiv = document.getElementById('loginError');
        if(!inputVal) { errorDiv.innerText = "Ingrese su nombre"; return; }

        try {
            const response = await fetch('/api/solicitudes_login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({identificador: inputVal})
            });
            const data = await response.json();

            if(data.success) {
                currentUser = data;
                isAdmin = data.es_admin;
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                document.getElementById('userNameDisplay').innerText = data.nombre;
                document.getElementById('inputFecha').value = getTodayDate();

                const roleBadge = document.getElementById('roleDisplay');
                const formContainer = document.getElementById('formContainer');

                if(isAdmin) {
                    roleBadge.innerText = "ADMINISTRADOR";
                    roleBadge.className = "badge bg-success";
                    formContainer.style.display = 'none';
                } else {
                    roleBadge.innerText = "SOLICITANTE";
                    roleBadge.className = "badge bg-secondary";
                    formContainer.style.display = 'block';
                }
                
                cargarSolicitudes();
            } else {
                errorDiv.innerText = data.message;
            }
        } catch (error) {
            errorDiv.innerText = "Error de conexi√≥n";
        }
    }

    async function cargarSolicitudes() {
        const container = document.getElementById('listaSolicitudes');
        container.innerHTML = '<p class="text-center">Cargando...</p>';

        try {
            const response = await fetch('/api/get_solicitudes');
            const data = await response.json();
            
            container.innerHTML = '';
            
            let lista = data.solicitudes;
            if(!isAdmin) {
                lista = lista.filter(s => s.solicitante_nombre === currentUser.nombre);
            }

            if(lista.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay solicitudes para mostrar.</p>';
                return;
            }

            lista.forEach(sol => {
                const isPendiente = sol.estado === 'Pendiente';
                const estadoClass = isPendiente ? 'text-danger' : 'text-success';
                const borderStyle = isPendiente ? 'border-left: 4px solid #8B4513;' : 'border-left: 4px solid #ccc; opacity: 0.7;';
                
                let btnHtml = '';
                if(isAdmin && isPendiente) {
                    btnHtml = `<button onclick="iniciarCierre('${sol.id}')" class="btn btn-sm btn-success float-end">‚úÖ Cerrar</button>`;
                }

                // Mostrar tipo de solicitud
                const tipoBadge = sol.tipo === 'Otro' 
                    ? '<span class="badge bg-info text-dark me-1">Otro</span>' 
                    : '<span class="badge bg-warning text-dark me-1">Devoluci√≥n</span>';

                // Mostrar datos bancarios solo si es devoluci√≥n y existen
                let extraInfo = '';
                if(sol.tipo === 'Devoluci√≥n') {
                    if(sol.banco) extraInfo += `<span class="badge bg-light text-dark me-1">${sol.banco}</span>`;
                    if(sol.rut) extraInfo += `<span class="badge bg-light text-dark me-1">RUT: ${sol.rut}</span>`;
                    if(sol.email) extraInfo += `<span class="badge bg-light text-dark">${sol.email}</span>`;
                    if(extraInfo !== '') extraInfo = `<div class="mt-1 small">${extraInfo}</div>`;
                }

                let cierreHtml = '';
                if (sol.comentario_cierre) {
                    cierreHtml = `<div class="alert alert-success p-1 mt-2 mb-0 small"><strong>Cierre:</strong> ${sol.comentario_cierre}</div>`;
                }

                // Determinar qu√© mostrar en el t√≠tulo
                let tituloHtml = '';
                if(sol.tipo === 'Devoluci√≥n') {
                    tituloHtml = `<p class="mb-1"><strong>Cliente:</strong> ${sol.cliente_nombre} <span class="text-muted">(Monto: $${sol.monto})</span></p>`;
                }

                const cardHtml = `
                    <div class="card mb-2" style="${borderStyle}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    ${tipoBadge}
                                    <span class="${estadoClass} fw-bold">[${sol.estado}]</span>
                                </div>
                                <small class="text-muted">${sol.timestamp.split(' ')[0]}</small>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="width: 85%">
                                    ${tituloHtml}
                                    <p class="mb-1 small text-secondary"><em>${sol.motivo || 'Sin detalle'}</em></p>
                                    ${extraInfo}
                                    ${cierreHtml}
                                    <small class="text-muted d-block mt-1">Por: ${sol.solicitante_nombre}</small>
                                </div>
                                ${btnHtml}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });

        } catch (e) {
            container.innerHTML = '<p class="text-danger">Error al cargar datos</p>';
        }
    }

    async function crearSolicitud() {
        const tipo = document.getElementById('inputTipo').value;
        
        const payload = {
            solicitante: currentUser.nombre,
            tipo: tipo, // Enviamos el tipo
            cliente: document.getElementById('inputCliente').value,
            monto: document.getElementById('inputMonto').value,
            banco: document.getElementById('inputBanco').value,
            rut: document.getElementById('inputRut').value,
            email: document.getElementById('inputEmail').value,
            motivo: document.getElementById('inputMotivo').value
        };

        // Validaci√≥n din√°mica
        if(tipo === 'Devoluci√≥n') {
            if(!payload.cliente || !payload.monto) {
                alert("Para devoluci√≥n, complete nombre de clienta y monto.");
                return;
            }
        } else {
            // Para "Otros", solo validamos el motivo
            if(!payload.motivo) {
                alert("Debe detallar su solicitud.");
                return;
            }
        }

        try {
            const response = await fetch('/api/create_solicitud', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if(data.success) {
                // Limpiar campos
                document.getElementById('inputCliente').value = '';
                document.getElementById('inputMonto').value = '';
                document.getElementById('inputBanco').value = '';
                document.getElementById('inputRut').value = '';
                document.getElementById('inputEmail').value = '';
                document.getElementById('inputMotivo').value = '';
                cargarSolicitudes();
            } else {
                alert(data.message);
            }
        } catch(e) { alert("Error al enviar"); }
    }

    function iniciarCierre(id) {
        const comentario = prompt("‚ö†Ô∏è Ingrese comentario de cierre:");
        if (comentario === null || comentario.trim() === "") {
            if(comentario !== null) alert("El comentario es obligatorio.");
            return;
        }
        confirmarCierre(id, comentario.trim());
    }

    async function confirmarCierre(id, comentario) {
        try {
            const response = await fetch('/api/close_solicitud', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id, comentario: comentario})
            });
            const data = await response.json();
            if(data.success) cargarSolicitudes();
            else alert(data.message);
        } catch(e) { alert("Error al cerrar"); }
    }

    function logout() {
        location.reload();
    }
</script>
{% endblock %}
