{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header del Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Dashboard de Reportes</h1>
                    <p class="text-muted mb-0" id="dateRangeText">Cargando datos...</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                    <a href="{{ url_for('info') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Fecha -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <form id="reportFilterForm">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="periodSelect" class="form-label">Período Rápido</label>
                                <select class="form-select" id="periodSelect" name="period">
                                    <option value="today">Hoy</option>
                                    <option value="week">Esta Semana</option>
                                    <option value="month">Este Mes</option>
                                    <option value="year">Este Año</option>
                                    <option value="custom">Rango Personalizado</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="startDateGroup" style="display: none;">
                                <label for="startDate" class="form-label">Fecha Inicio</label>
                                <input type="date" class="form-control" id="startDate" name="start_date">
                            </div>
                            <div class="col-md-3" id="endDateGroup" style="display: none;">
                                <label for="endDate" class="form-label">Fecha Fin</label>
                                <input type="date" class="form-control" id="endDate" name="end_date">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-2"></i>Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Métricas Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Ventas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSales">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Ingresos Totales
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAmount">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Puntos Activos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="activeLocations">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-store fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Ticket Promedio
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="averageTicket">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-receipt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos y Tablas -->
    <div class="row">
        <!-- Productos Más Vendidos -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Top 10 Productos por Ingresos</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="topProductsTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Ventas</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ventas por Ubicación -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-success">Ventas por Ubicación</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="locationSalesTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Ubicación</th>
                                    <th>Ventas</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evolución Diaria -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Evolución Diaria de Ventas</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dailySalesTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Ventas</th>
                                    <th>Ingresos</th>
                                    <th>Puntos Activos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen del Período -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">Resumen del Período</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center" id="periodSummary">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
let currentFilters = {
    period: 'today',
    start_date: null,
    end_date: null
};

// Inicializar fechas por defecto
function initializeDates() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
}

// Manejar cambio en el selector de período
document.getElementById('periodSelect').addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    document.getElementById('startDateGroup').style.display = isCustom ? 'block' : 'none';
    document.getElementById('endDateGroup').style.display = isCustom ? 'block' : 'none';
});

// Manejar envío del formulario de filtros
document.getElementById('reportFilterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    currentFilters = {
        period: formData.get('period') || 'today',
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date')
    };
    
    loadDashboardData();
});

// Función para formatear moneda
function formatCurrency(amount) {
    if (typeof amount === 'string') {
        amount = parseInt(amount.replace(/[^0-9]/g, '')) || 0;
    }
    return '$' + amount.toLocaleString('es-CL');
}

// Función para calcular ticket promedio
function calculateAverageTicket(totalAmount, totalSales) {
    if (totalSales === 0) return 0;
    return Math.round(totalAmount / totalSales);
}

// Cargar datos del dashboard con filtros
function loadDashboardData() {
    const params = new URLSearchParams();
    
    if (currentFilters.period) {
        params.append('period', currentFilters.period);
    }
    
    if (currentFilters.start_date && currentFilters.end_date) {
        params.append('start_date', currentFilters.start_date);
        params.append('end_date', currentFilters.end_date);
    }
    
    showNotification('Cargando datos...', 'info');
    
    fetch(`/api/reports?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            updateDashboard(data);
            showNotification('Datos actualizados correctamente', 'success');
        })
        .catch(error => {
            console.error('Error cargando datos del dashboard:', error);
            showNotification('Error al cargar los datos del dashboard', 'error');
        });
}

// Actualizar la interfaz con los datos
function updateDashboard(data) {
    // Actualizar texto del rango de fechas
    const dateRangeText = document.getElementById('dateRangeText');
    if (data.date_range.start === data.date_range.end) {
        dateRangeText.textContent = `Reporte del ${data.date_range.start}`;
    } else {
        dateRangeText.textContent = `Reporte del ${data.date_range.start} al ${data.date_range.end}`;
    }
    
    // Actualizar tarjetas principales
    document.getElementById('totalSales').textContent = data.total_sales;
    document.getElementById('totalAmount').textContent = formatCurrency(data.total_amount);
    document.getElementById('activeLocations').textContent = data.active_locations;
    document.getElementById('averageTicket').textContent = formatCurrency(
        calculateAverageTicket(data.total_amount, data.total_sales)
    );
    
    // Actualizar productos más vendidos
    updateTopProductsTable(data.top_products);
    
    // Actualizar ventas por ubicación
    updateLocationSalesTable(data.location_sales);
    
    // Actualizar evolución diaria
    updateDailySalesTable(data.daily_data);
    
    // Actualizar resumen del período
    updatePeriodSummary(data);
}

function updateTopProductsTable(topProducts) {
    const tableBody = document.querySelector('#topProductsTable tbody');
    
    if (topProducts.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay ventas en el período seleccionado</td></tr>';
        return;
    }
    
    tableBody.innerHTML = topProducts.map(([code, info]) => `
        <tr>
            <td>
                <strong>${code}</strong><br>
                <small class="text-muted">${info.description}</small>
            </td>
            <td class="text-center"><span class="badge bg-primary">${info.count}</span></td>
            <td class="text-end">${formatCurrency(info.amount)}</td>
        </tr>
    `).join('');
}

function updateLocationSalesTable(locationSales) {
    const tableBody = document.querySelector('#locationSalesTable tbody');
    const locations = Object.keys(locationSales);
    
    if (locations.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay ventas por ubicación</td></tr>';
        return;
    }
    
    tableBody.innerHTML = locations.map(location => {
        const sales = locationSales[location];
        return `
            <tr>
                <td><strong>${location}</strong></td>
                <td class="text-center">${sales.count}</td>
                <td class="text-end">${formatCurrency(sales.amount)}</td>
            </tr>
        `;
    }).join('');
}

function updateDailySalesTable(dailyData) {
    const tableBody = document.querySelector('#dailySalesTable tbody');
    const dates = Object.keys(dailyData).sort();
    
    if (dates.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay datos diarios</td></tr>';
        return;
    }
    
    tableBody.innerHTML = dates.map(date => {
        const dayData = dailyData[date];
        return `
            <tr>
                <td><strong>${date}</strong></td>
                <td class="text-center">${dayData.sales}</td>
                <td class="text-end">${formatCurrency(dayData.amount)}</td>
                <td class="text-center">${dayData.locations}</td>
            </tr>
        `;
    }).join('');
}

function updatePeriodSummary(data) {
    const container = document.getElementById('periodSummary');
    
    const avgDailySales = data.total_sales / Object.keys(data.daily_data).length;
    const avgDailyAmount = data.total_amount / Object.keys(data.daily_data).length;
    
    container.innerHTML = `
        <div class="col-md-3 mb-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h4 class="text-primary">${Math.round(avgDailySales)}</h4>
                    <p class="mb-0 text-muted">Ventas Diarias Promedio</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h4 class="text-success">${formatCurrency(Math.round(avgDailyAmount))}</h4>
                    <p class="mb-0 text-muted">Ingreso Diario Promedio</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h4 class="text-info">${Object.keys(data.daily_data).length}</h4>
                    <p class="mb-0 text-muted">Días con Ventas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h4 class="text-warning">${data.active_locations}</h4>
                    <p class="mb-0 text-muted">Puntos Únicos Activos</p>
                </div>
            </div>
        </div>
    `;
}

// Función para refrescar el dashboard
function refreshDashboard() {
    loadDashboardData();
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();
    loadDashboardData();
    
    // Auto-refresh cada 5 minutos
    setInterval(loadDashboardData, 300000);
});
</script>
{% endblock %}