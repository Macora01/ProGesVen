{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header del Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-brown-primary">Dashboard de Reportes</h1>
                    <p class="text-brown-light mb-0" id="dateRangeText">Cargando datos...</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-custom" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>Actualizar
                    </button>
                    <a href="{{ url_for('info') }}" class="btn btn-brown-outline">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Fecha -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <form id="reportFilterForm">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="periodSelect" class="form-label text-brown-dark">Período Rápido</label>
                                <select class="form-select border-brown" id="periodSelect" name="period">
                                    <option value="today">Hoy</option>
                                    <option value="week">Esta Semana</option>
                                    <option value="month">Este Mes</option>
                                    <option value="year">Este Año</option>
                                    <option value="custom">Rango Personalizado</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="startDateGroup" style="display: none;">
                                <label for="startDate" class="form-label text-brown-dark">Fecha Inicio</label>
                                <input type="date" class="form-control border-brown" id="startDate" name="start_date">
                            </div>
                            <div class="col-md-3" id="endDateGroup" style="display: none;">
                                <label for="endDate" class="form-label text-brown-dark">Fecha Fin</label>
                                <input type="date" class="form-control border-brown" id="endDate" name="end_date">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-custom w-100">
                                    <i class="fas fa-filter me-2"></i>Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Métricas Principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Ventas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSales">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Devoluciones
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalReturns">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-undo fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Ventas Netas
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="netSales">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Ingresos Netos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAmount">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor para mensaje de no datos -->
    <div id="noDataMessage" class="alert alert-info" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>No hay datos disponibles para el período seleccionado.
    </div>

    <!-- Gráficos Principales (se muestran solo si hay datos) -->
    <div id="chartsSection" style="display: none;">
        <div class="row mb-4">
            <!-- Gráfico de Evolución Diaria -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-brown-primary">Evolución Diaria de Ventas y Devoluciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="dailyEvolutionChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Productos Top -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-brown-primary">Top 5 Productos por Ingresos</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-4 pb-2">
                            <canvas id="topProductsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tablas de Detalles -->
        <div class="row">
            <!-- Productos Más Vendidos -->
            <div class="col-xl-6 col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-brown-primary">Top 10 Productos por Ingresos Netos</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="topProductsTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th class="text-brown-dark">Producto</th>
                                        <th class="text-brown-dark">Ventas Netas</th>
                                        <th class="text-brown-dark">Total Neto</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsTableBody">
                                    <!-- Se llenará con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ventas por Ubicación -->
            <div class="col-xl-6 col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-brown-primary">Ventas Netas por Ubicación</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="locationSalesTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th class="text-brown-dark">Ubicación</th>
                                        <th class="text-brown-dark">Ventas Netas</th>
                                        <th class="text-brown-dark">Total Neto</th>
                                    </tr>
                                </thead>
                                <tbody id="locationSalesTableBody">
                                    <!-- Se llenará con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evolución Diaria Detallada -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-brown-primary">Evolución Diaria Detallada</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="dailySalesTable" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th class="text-brown-dark">Fecha</th>
                                        <th class="text-brown-dark">Ventas</th>
                                        <th class="text-brown-dark">Devoluciones</th>
                                        <th class="text-brown-dark">Ventas Netas</th>
                                        <th class="text-brown-dark">Ingresos Netos</th>
                                        <th class="text-brown-dark">Puntos Activos</th>
                                    </tr>
                                </thead>
                                <tbody id="dailySalesTableBody">
                                    <!-- Se llenará con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary { border-left: 0.25rem solid #4e73df !important; }
.border-left-success { border-left: 0.25rem solid #1cc88a !important; }
.border-left-info { border-left: 0.25rem solid #36b9cc !important; }
.border-left-warning { border-left: 0.25rem solid #f6c23e !important; }

.chart-area { 
    position: relative; 
    height: 20rem; 
    width: 100%;
}
.chart-pie { 
    position: relative; 
    height: 16rem; 
    width: 100%;
}

/* Estilos responsivos */
@media (max-width: 768px) {
    .chart-area { height: 15rem; }
    .chart-pie { height: 12rem; }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables globales
let currentFilters = {
    period: 'today',
    start_date: null,
    end_date: null
};

let dailyEvolutionChart = null;
let topProductsChart = null;

// Inicializar fechas por defecto
function initializeDates() {
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById('startDate')) {
        document.getElementById('startDate').value = today;
    }
    if (document.getElementById('endDate')) {
        document.getElementById('endDate').value = today;
    }
}

// Manejar cambio en el selector de período
document.getElementById('periodSelect').addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    document.getElementById('startDateGroup').style.display = isCustom ? 'block' : 'none';
    document.getElementById('endDateGroup').style.display = isCustom ? 'block' : 'none';
});

// Manejar envío del formulario de filtros
document.getElementById('reportFilterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    currentFilters = {
        period: formData.get('period') || 'today',
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date')
    };
    
    loadDashboardData();
});

// Función para formatear moneda
function formatCurrency(amount) {
    if (typeof amount === 'string') {
        amount = parseInt(amount.replace(/[^0-9-]/g, '')) || 0;
    }
    const formatted = Math.abs(amount).toLocaleString('es-CL');
    return amount < 0 ? `-$${formatted}` : `$${formatted}`;
}

// Cargar datos del dashboard con filtros
function loadDashboardData() {
    const params = new URLSearchParams();
    
    if (currentFilters.period) {
        params.append('period', currentFilters.period);
    }
    
    if (currentFilters.start_date && currentFilters.end_date) {
        params.append('start_date', currentFilters.start_date);
        params.append('end_date', currentFilters.end_date);
    }
    
    showNotification('Cargando datos...', 'info');
    
    fetch(`/api/reports?${params.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }
            return response.json();
        })
        .then(data => {
            updateDashboard(data);
            showNotification('Datos actualizados correctamente', 'success');
        })
        .catch(error => {
            console.error('Error cargando datos del dashboard:', error);
            showNotification('Error al cargar los datos del dashboard: ' + error.message, 'error');
            // Mostrar mensaje de no datos
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'none';
        });
}

// Actualizar la interfaz con los datos
function updateDashboard(data) {
    console.log('Datos recibidos:', data); // Para debug
    
    // Actualizar texto del rango de fechas
    const dateRangeText = document.getElementById('dateRangeText');
    if (data.date_range && data.date_range.start === data.date_range.end) {
        dateRangeText.textContent = `Reporte del ${data.date_range.start}`;
    } else if (data.date_range) {
        dateRangeText.textContent = `Reporte del ${data.date_range.start} al ${data.date_range.end}`;
    } else {
        dateRangeText.textContent = 'Reporte del período seleccionado';
    }
    
    // Verificar si hay datos
    const hasData = data.total_sales > 0 || data.total_returns > 0;
    
    if (hasData) {
        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('chartsSection').style.display = 'block';
        
        // Actualizar tarjetas principales
        document.getElementById('totalSales').textContent = data.total_sales.toLocaleString('es-CL');
        document.getElementById('totalReturns').textContent = data.total_returns.toLocaleString('es-CL');
        document.getElementById('netSales').textContent = (data.total_sales - data.total_returns).toLocaleString('es-CL');
        document.getElementById('totalAmount').textContent = formatCurrency(data.total_amount);
        
        // Actualizar gráficos si existen datos de gráficos
        if (data.chart_data) {
            updateCharts(data.chart_data);
        }
        
        // Actualizar tablas
        updateTopProductsTable(data.top_products || []);
        updateLocationSalesTable(data.location_sales || {});
        updateDailySalesTable(data.daily_data || {});
    } else {
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('chartsSection').style.display = 'none';
        
        // Limpiar tarjetas
        document.getElementById('totalSales').textContent = '0';
        document.getElementById('totalReturns').textContent = '0';
        document.getElementById('netSales').textContent = '0';
        document.getElementById('totalAmount').textContent = '$0';
    }
}

// Actualizar gráficos
function updateCharts(chartData) {
    // Destruir gráficos existentes
    if (dailyEvolutionChart) {
        dailyEvolutionChart.destroy();
    }
    if (topProductsChart) {
        topProductsChart.destroy();
    }
    
    // Gráfico de evolución diaria
    const dailyCtx = document.getElementById('dailyEvolutionChart');
    if (dailyCtx && chartData.daily_evolution && chartData.daily_evolution.dates.length > 0) {
        dailyEvolutionChart = new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: chartData.daily_evolution.dates,
                datasets: [
                    {
                        label: 'Ventas',
                        data: chartData.daily_evolution.sales,
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Devoluciones',
                        data: chartData.daily_evolution.returns,
                        borderColor: '#f6c23e',
                        backgroundColor: 'rgba(246, 194, 62, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: "rgba(0, 0, 0, .125)",
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de productos top
    const productsCtx = document.getElementById('topProductsChart');
    if (productsCtx && chartData.top_products && chartData.top_products.names.length > 0) {
        topProductsChart = new Chart(productsCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.top_products.names,
                datasets: [{
                    data: chartData.top_products.amounts,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
                    ],
                    hoverBackgroundColor: [
                        '#2e59d9', '#17a673', '#2c9faf', '#f4b619', '#e02d1b'
                    ],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                cutout: '70%',
            },
        });
    }
}

function updateTopProductsTable(topProducts) {
    const tableBody = document.getElementById('topProductsTableBody');
    
    if (!topProducts || topProducts.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay productos vendidos en el período</td></tr>';
        return;
    }
    
    tableBody.innerHTML = topProducts.map(([code, info]) => `
        <tr>
            <td>
                <strong>${code}</strong><br>
                <small class="text-muted">${info.description}</small>
            </td>
            <td class="text-center"><span class="badge bg-primary">${info.count}</span></td>
            <td class="text-end">${formatCurrency(info.amount)}</td>
        </tr>
    `).join('');
}

function updateLocationSalesTable(locationSales) {
    const tableBody = document.getElementById('locationSalesTableBody');
    const locations = Object.keys(locationSales);
    
    if (!locations || locations.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay ventas por ubicación</td></tr>';
        return;
    }
    
    tableBody.innerHTML = locations.map(location => {
        const sales = locationSales[location];
        return `
            <tr>
                <td><strong>${location}</strong></td>
                <td class="text-center">${sales.count}</td>
                <td class="text-end">${formatCurrency(sales.amount)}</td>
            </tr>
        `;
    }).join('');
}

function updateDailySalesTable(dailyData) {
    const tableBody = document.getElementById('dailySalesTableBody');
    const dates = Object.keys(dailyData).sort();
    
    if (!dates || dates.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay datos diarios</td></tr>';
        return;
    }
    
    tableBody.innerHTML = dates.map(date => {
        const dayData = dailyData[date];
        const netSales = dayData.sales - dayData.returns;
        
        return `
            <tr>
                <td><strong>${date}</strong></td>
                <td class="text-center text-success">${dayData.sales}</td>
                <td class="text-center text-warning">${dayData.returns}</td>
                <td class="text-center"><strong>${netSales}</strong></td>
                <td class="text-end">${formatCurrency(dayData.amount)}</td>
                <td class="text-center">${dayData.locations}</td>
            </tr>
        `;
    }).join('');
}

// Función para refrescar el dashboard
function refreshDashboard() {
    loadDashboardData();
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    initializeDates();
    loadDashboardData();
});
</script>
{% endblock %}